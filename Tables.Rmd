---
title: "Tables - MELTING 5"
author: "J. Aravind"
date: "8 February 2018"
output:
  pdf_document: default
  html_document: default
  word_document: default
bibliography: inst/REFERENCES.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment =  "#'")
library(readxl)
# library(RefManageR)
# 
# tabular <- function(df, ...) {
#   stopifnot(is.data.frame(df))
# 
#   align <- function(x) if (is.numeric(x)) "r" else "l"
#   col_align <- vapply(df, align, character(1))
# 
#   cols <- lapply(df, format, ...)
#   contents <- do.call("paste",
#                       c(cols, list(sep = " \\tab ", collapse = "\\cr\n  ")))
# 
#   paste("\\tabular{", paste(col_align, collapse = ""), "}{\n  ",
#         contents, "\n}\n", sep = "")
# }





# Dat <- data.frame(a = rep("this value consists of a long string of text", 5),
#                   b = rep("this value consists of an even longer string of text", 5))
# df <- Dat
# maxchar <- c(10, 25)

library(rowr)
library(dplyr)
library(plyr)
library(data.table)




tabular <- function(df, header=TRUE, maxchar, ...) {
  stopifnot(is.data.frame(df))
  
  df[is.na(df)] <- ""
  
  dfdata <- df
  #colnames(dfdata) <- NULL
  dfdata <- tabularwrap(df = dfdata, maxchar = maxchar)
  
  if (header) {
    dfcol <- data.frame(t(colnames(df)))
    
    dfcol <- tabularwrap(df = dfcol, maxchar = maxchar)
    
    dfcol <- dplyr::mutate_all(dfcol, function(x) paste("\\strong{", x, "}", sep = ""))
    
    df2 <- rbind(dfcol, dfdata)
  } else {
      df2 <- dfdata
  }
  
  #df2 <- sapply(df2, as.character)
  df2[is.na(df2)] <- ""
  #df2 <- as.data.frame(df2)
  
  align <- function(x) if (is.numeric(x)) "r" else "l"
  col_align <- vapply(df2, align, character(1))
  
  cols <- lapply(df2, format, ...)
  contents <- do.call("paste",
                      c(cols, list(sep = " \\tab ", collapse = "\\cr\n  ")))
  
  paste("\\tabular{", paste(col_align, collapse = ""), "}{\n  ",
        contents, "\n}\n", sep = "")
  
}




tabularwrap <- function(df, maxchar){
  
  # convert all columns to character
  colnames(df) <- paste("col", "_", 1:ncol(df), sep = "")
  df <- dplyr::mutate_all(df, as.character)
  df2 <- vector(length = ncol(df), mode = "list")
  
  for(i in 1:ncol(df)){
    
    # df2[[i]] <- strsplit(df[[i]], paste("(?<=.{",maxchar[i], "})", sep = ""),
    #                      perl = TRUE)
    df2[[i]] <- strwrap(df[[i]], width = maxchar[i], simplify = FALSE)
    
    df2[[i]] <- lapply(df2[[i]], data.frame)
    df2[[i]] <- lapply(df2[[i]], function(x) cbind(`.id2` = 1:nrow(x), x))
    names(df2[[i]]) <- paste("X", 1:nrow(df), sep = "")
    df2[[i]] <- plyr::ldply(df2[[i]])
    rownames(df2[[i]]) <- paste(df2[[i]]$.id, "_", df2[[i]]$.id2, sep ="")
    df2[[i]]$.id <- NULL
    df2[[i]]$.id2 <- NULL
    df2[[i]] <- data.frame(t(df2[[i]]))
    rownames(df2[[i]]) <- NULL
    
  }
  
  #df3 <- bind_rows(df2)
  
  df2 <- data.table::rbindlist(df2, fill = TRUE)
  
  df2 <- data.frame(t(df2))
  
  df2 <- df2[order(row.names(df2)),]
  
  trim <- function(x) gsub("^\\s+|\\s+$", "", x)
  
  df2 <- dplyr::mutate_all(df2, trim)
  
  return(df2)
  
}


```

```{r}
# bib <- ReadBib("inst/REFERENCES.bib")
bib <- bibtex::read.bib("inst/REFERENCES.bib")
 
# BibOptions(check.entries = FALSE, bib.style = "authoryear", max.names = 1,
#             style = "citation", bibpunct = c("","","(",")",";",","))
 
# Cite(bib, "mathews_expanded_1999")
# Cite(bib, "watkins_nearest-neighbor_2005")


bibpunctuation = c("", "", ";", "a", ",", ",")
# citeNatbib("mathews_expanded_1999", bib, bibpunct = bibpunctuation)
# citeNatbib("watkins_nearest-neighbor_2005", bib, bibpunct = bibpunctuation)
```

```{r}
rmeltingtables <- function(x, def="default",
                           code="Formula", ref = "Reference") {
  
  # BibOptions(check.entries = FALSE, bib.style = "authoryear", max.names = 1,
  #           style = "citation", bibpunct = c("","","(",")",";",","))
  
  # colnames(x) <- as.character(x[strong,])
  # x[strong,] <- paste0("\\strong{", as.character(x[strong,]),"}", sep="")
  x[,code] <- paste0("\\code{", unlist(x[,code]), "}", sep = "")
  
  if(!is.null(def)) {
    ind <- which(is.na(x[,def]) %in% FALSE)
    x[ind,code] <- paste0(unlist(x[ind,code]), unlist(x[ind,def]), sep = "")
    rm(ind)
  }

  x[, def] <- NULL
  
  y <- unlist(x[, ref])
  y <- gsub("@|\\[|\\]", "", y)
  
  y <- strsplit(y, "; ")
  # y <- unlist(lapply(y, function(x) Cite(bib,x)))
    y <- unlist(lapply(y,function(x) citeNatbib(x, bib,
                                                 bibpunct = bibpunctuation)))
  y <- gsub(", (?=et al\\.)", " ", y, perl=TRUE)
  # y <- gsub("(?<!et al\\.), (?=\\d)", " ", y, perl=TRUE)
  y <- unlist(y)
  
  x[, ref] <- gsub("\\n", " ", y)
  
  x <- data.frame(x)

  cat(tabular(x, header = TRUE, maxchar = c(22, 4, 30, 30)))
}

```


## Approx.methods
```{r}
approx <- read_excel("Tables.xlsx", sheet = "Approx.methods", col_names = T)
knitr::kable(approx)
rmeltingtables(approx, def = "default", code = "Formula",
               ref = "Reference")
```

## NN.methods
```{r}
NN <- read_excel("Tables.xlsx", sheet = "NN.methods", col_names = T)
knitr::kable(NN)
rmeltingtables(NN, def = "default", code = "Model",
               ref = "Reference")
```
## GU.methods
```{r}
GU.methods <- read_excel("Tables.xlsx", sheet = "GU.methods", col_names = T)
knitr::kable(GU.methods)
rmeltingtables(GU.methods, def = "default", code = "Model",
               ref = "Reference")
```
## singleMM.methods
```{r}
singleMM.methods <- read_excel("Tables.xlsx", sheet = "singleMM.methods", col_names = T)
knitr::kable(singleMM.methods)
rmeltingtables(singleMM.methods, def = "default", code = "Model",
               ref = "Reference")
```
## tandemMM.methods
```{r}
tandemMM.methods <- read_excel("Tables.xlsx", sheet = "tandemMM.methods", col_names = T)
knitr::kable(tandemMM.methods)
rmeltingtables(tandemMM.methods, def = "default", code = "Model",
               ref = "Reference")
```
## single.dangle.methods
```{r}
# BibOptions(check.entries = FALSE, bib.style = "authoryear", max.names = 1,
#             style = "citation", bibpunct = c("","","(",")",";",","))

single.dangle.methods <- read_excel("Tables.xlsx", sheet = "single.dangle.methods", col_names = T)
knitr::kable(single.dangle.methods)
rmeltingtables(single.dangle.methods, def = "default", code = "Model",
               ref = "Reference")
```

## double.dangle.methods
```{r}
double.dangle.methods <- read_excel("Tables.xlsx", sheet = "double.dangle.methods", col_names = T)
knitr::kable(double.dangle.methods)
rmeltingtables(double.dangle.methods, def = "default", code = "Model",
               ref = "Reference")
```

## long.dangle.methods
```{r}
long.dangle.methods <- read_excel("Tables.xlsx", sheet = "long.dangle.methods", col_names = T)
knitr::kable(long.dangle.methods)
rmeltingtables(long.dangle.methods, def = "default", code = "Model",
               ref = "Reference")
```

## internal.loop.methods
```{r}
internal.loop.methods <- read_excel("Tables.xlsx", sheet = "internal.loop.methods", col_names = T)
knitr::kable(internal.loop.methods)
rmeltingtables(internal.loop.methods, def = "default", code = "Model",
               ref = "Reference")
```

## single.bulge.loop.methods
```{r}
single.bulge.loop.methods <- read_excel("Tables.xlsx", sheet = "single.bulge.loop.methods", col_names = T)
knitr::kable(single.bulge.loop.methods)
rmeltingtables(single.bulge.loop.methods, def = "default", code = "Model",
               ref = "Reference")
```

## long.bulge.loop.methods
```{r}
long.bulge.loop.methods <- read_excel("Tables.xlsx", sheet = "long.bulge.loop.methods", col_names = T)
knitr::kable(long.bulge.loop.methods)
rmeltingtables(long.bulge.loop.methods, def = "default", code = "Model",
               ref = "Reference")
```

## CNG.methods
```{r}
CNG.methods <- read_excel("Tables.xlsx", sheet = "CNG.methods", col_names = T)
knitr::kable(CNG.methods)
rmeltingtables(CNG.methods, def = "default", code = "Model",
               ref = "Reference")
```

## inosine.methods
```{r}
inosine.methods <- read_excel("Tables.xlsx", sheet = "inosine.methods", col_names = T)
knitr::kable(inosine.methods)
rmeltingtables(inosine.methods, def = "default", code = "Model",
               ref = "Reference")
```

## hydroxyadenine.methods
```{r}
hydroxyadenine.methods <- read_excel("Tables.xlsx", sheet = "hydroxyadenine.methods", col_names = T)
knitr::kable(hydroxyadenine.methods)
rmeltingtables(hydroxyadenine.methods, def = "default", code = "Model",
               ref = "Reference")
```

## azobenzenes.methods
```{r}
azobenzenes.methods <- read_excel("Tables.xlsx", sheet = "azobenzenes.methods", col_names = T)
knitr::kable(azobenzenes.methods)
rmeltingtables(azobenzenes.methods, def = "default", code = "Model",
               ref = "Reference")
```

## locked.methods
```{r}
locked.methods <- read_excel("Tables.xlsx", sheet = "locked.methods", col_names = T)
knitr::kable(locked.methods)
rmeltingtables(locked.methods, def = "default", code = "Model",
               ref = "Reference")
```

## na.correction
```{r}
na.correction <- read_excel("Tables.xlsx", sheet = "na.correction", col_names = T)
knitr::kable(na.correction)
rmeltingtables(na.correction, def = "default", code = "Correcion",
               ref = "Reference")
```

## mg.correction
```{r}
mg.correction <- read_excel("Tables.xlsx", sheet = "mg.correction", col_names = T)
knitr::kable(mg.correction)
rmeltingtables(mg.correction, def = "default", code = "Correcion",
               ref = "Reference")
```

## NaMg.correction
```{r}
NaMg.correction <- read_excel("Tables.xlsx", sheet = "NaMg.correction", col_names = T)
knitr::kable(NaMg.correction)
rmeltingtables(NaMg.correction, def = "default", code = "Correcion",
               ref = "Reference")
```

## Naeq.methods
```{r}
Naeq.methods <- read_excel("Tables.xlsx", sheet = "Naeq.methods", col_names = T)
knitr::kable(Naeq.methods)
rmeltingtables(Naeq.methods, def = "default", code = "Correcion",
               ref = "Reference")
```

## DMSO.methods
```{r}
DMSO.methods <- read_excel("Tables.xlsx", sheet = "DMSO.methods", col_names = T)
knitr::kable(DMSO.methods)
rmeltingtables(DMSO.methods, def = "default", code = "Correcion",
               ref = "Reference")
```

## formamide.methods
```{r}
formamide.methods <- read_excel("Tables.xlsx", sheet = "formamide.methods", col_names = T)
knitr::kable(formamide.methods)
rmeltingtables(formamide.methods, def = "default", code = "Correcion",
               ref = "Reference")
```


## References
